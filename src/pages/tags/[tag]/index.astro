---
export const prerender = true

import { getCollection } from 'astro:content'
import DefaultPageLayout from '$/layouts/default.astro'
import PostPreviewList from '$/components/PostPreviewList.astro'
import type { Tag } from '$/content/config'
import type { Frontmatter } from '$/types'
import { fromCollectionToFrontmatters } from '$/utils'

export async function getStaticPaths({}) {
  const collection = await getCollection('owned')
  const allTags = new Set()
  collection.map((entry) => {
    entry.data.tagList && entry.data.tagList.map((tag) => allTags.add(tag))
  })

  return Array.from(allTags).map((tag) => {
    const filteredCollection = collection.filter((entry) =>
      entry.data.tagList.includes(tag)
    )

    console.log(filteredCollection, tag)
    return {
      params: { tag },
      props: {
        posts: fromCollectionToFrontmatters(filteredCollection),
      },
    }
  })
}

const { posts } = Astro.props as { posts: Frontmatter[] }
const { tag } = Astro.params as { tag: Tag }
---

<DefaultPageLayout
  content={{
    title: `Posts by Tag: ${tag}`,
    description: `all of the articles we have posted and linked so far under the tag: ${tag}`,
  }}
>
  <PostPreviewList posts={posts} />
</DefaultPageLayout>
